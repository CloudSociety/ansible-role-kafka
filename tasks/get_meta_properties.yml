# # SPDX-License-Identifier: GPL-3.0-only
# Copyright (C) 2025 Cloud Society Org.
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License version 3,
# as published by the Free Software Foundation.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <https://www.gnu.org/licenses/>.

---
- name: Configure Kafka storage
  block:
    - name: Check if Data Directories are Formatted # noqa: command-instead-of-shell
      ansible.builtin.shell: "/bin/kafka-storage info -c {{ kafka_files.server_conf }}"
      ignore_errors: true
      failed_when: false
      register: formatted

    - name: Generate uuid on first controller node in order to use it as ClusterId # noqa: command-instead-of-shell
      ansible.builtin.shell: "/bin/kafka-storage random-uuid"
      environment:
        KAFKA_OPTS: "-Xlog:all=error -XX:+IgnoreUnrecognizedVMOptions"
      register: uuid_key
      run_once: true
      changed_when: false
      delegate_to: "{{ kafka_group_hosts | select('contains', 'controller') | list | sort | first }}"

    - name: Format Data Directory
      ansible.builtin.shell: |
        /bin/kafka-storage format \
        -t={{ uuid_key.stdout }} -c {{ kafka_files.server_conf }} --ignore-formatted
      register: format_meta
      when:
        - formatted.rc == 1
        - uuid_key is defined
